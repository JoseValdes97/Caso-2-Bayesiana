---
title: "Caso 2(Principal)"
author: "Joan Lamprea y Jose Valdes"
date: "2023-05-04"
output: html_document
---

```{r setup, include=FALSE}
suppressMessages(suppressWarnings(library(dplyr)))
suppressMessages(suppressWarnings(library(metRology)))
knitr::opts_chunk$set(echo = TRUE)
#modelo 3
source("D:/jose/CasoBayes2/modelo_3.R")
#modelo 4
source("D:/jose/CasoBayes2/modelo_4.R")
#modelo 5
source("D:/jose/CasoBayes2/modelo_5.R")
```

# Caso 2 de bayesiana

## Base de datos

```{r}
# cargar los datos
load("D:/jose/CasoBayes2/Personas.Rdata")
# mira Na en ingtot
sum(is.na(dat$ingtot))
```
Teniendo encuenta lo anterior extraeremos de la base de datos las varibles
para el caso las cuales son **dominio** y **ingtot**. Organizamos los datos
teniendo encuenta que:  

 1. Recordamos que la función log tiene base $e$.  
 2. La varaible **dominio** es un factor 

```{r}
#datos que voy a usar
Data <- data.frame(dat$dominio, dat$ingtot)
#nombres
names(Data) <- c("Dominio","Ingtot")
# pasamos los Ingtot a escala logaritmica
Data[,2] <- log(Data$Ingtot)
# presentar datos
head(Data)
# comprobar media,varianza  y precisión
mean(Data$Ingtot)
var(Data$Ingtot)
1/var(Data$Ingtot)
# volver factor domionio
class(Data$Dominio)
Data[,1] <- as.factor(Data$Dominio)
summary(Data$Dominio)
```

Ahora con esto obtendremos los datos que nos son relevantes para eltrabajo  
desde la base de datos cómo:

```{r}
# m <- Cantidad de dominios (Departamentos)
m <- length(table(Data$Dominio))
m
# n <- número de individuos
n <- sum(table(Data$Dominio))
n
# y <- vector con los datos
y <- Data$Ingtot
head(y)
```

Obtendremos una tabla con los estadísticos necesarios por dominio para trabajar con las distribuciones condicionales completas y tener una idea de los datos.

 1. la función **n()** solo funciona dentro de una funcion actual como summarise     en el estado actual y devuelve el tamaño del grupo

```{r}
# tabla con los estadisticos
Estadisticos <- Data %>% 
      group_by(Dominio) %>% 
      summarise(Dominio = unique(Dominio), nj = n(), yb = mean(Ingtot),
                s2 = var(Ingtot))
head(Estadisticos)
# almacenar info importante
nj <- Estadisticos$nj
yb <- Estadisticos$yb
s2 <- Estadisticos$s2
```


## Modelo 3

Hiperparámetros del modelo.

$\textsf{M}_3$: $\mu_0 = 13.495$, $\gamma_0^2 = 11.382$, $\eta_0 = 1$, $\tau^2_0 = 1.182$, $\nu = 1$, $\alpha_0 = 1$, $\beta_0 = 0.846$.

Ejecución del modelo

```{r}
#ajustar modelo
tictoc::tic()
set.seed(1856)
cadena1_M3 <- MCMC_3(y,B = 11000, nj, yb, s2)
tictoc::toc()
```
### Convergencia

Usaremos la log-verosimilitud para mirar la convergencia de la cadena

```{r}
# Gráfico
yrange <- range(cadena1_M3$LL$ll)
plot(cadena1_M3$LL$ll, type = "p", pch = ".", cex = 1.1, col = "red", ylim = yrange,  xlab = "Iteración",ylab = "Log-verosimilitud", main = "Modelo 3")
```

## Modelo 4

Hiperparámetros del modelo.

$\textsf{M}_4$: $\mu_0 = 13.495$, $\gamma_0^2 = 11.382$, $\alpha_0 = 1$, $\beta_0 = 0.846$, $\kappa = 3$.

Ejecución del modelo

```{r}
#ajustar modelo
tictoc::tic()
set.seed(1856)
cadena1_M4 <- MCMC_4(y,B = 11000, nj)
tictoc::toc()
```
### Convergencia

Usaremos la log-verosimilitud para mirar la convergencia de la cadena

```{r}
# Gráfico
yrange <- range(cadena1_M4$LL$ll)
plot(cadena1_M4$LL$ll, type = "p", pch = ".", cex = 1.1, col = "blue", ylim = yrange,  xlab = "Iteración",ylab = "Log-verosimilitud", main = "Modelo 4")
```

## Modelo 5

Hiperparámetros del modelo.
 
$\textsf{M}_5$: $\mu_0 = 13.495$, $\gamma_0^2 = 11.382$, $\eta_0 = 1$, $\tau^2_0 = 1.182$, $\alpha_0 = 1$, $\beta_0 = 0.846$, $\kappa = 3$.

Ejecución del modelo

```{r}
#ajustar modelo
tictoc::tic()
set.seed(1856)
cadena1_M5 <- MCMC_5(y,B = 11000, nj, yb)
tictoc::toc()
```

### Convergencia

Usaremos la log-verosimilitud para mirar la convergencia de la cadena

```{r}
# Gráfico
yrange <- range(cadena1_M5$LL$ll)
plot(cadena1_M5$LL$ll, type = "p", pch = ".", cex = 1.1, col = "green", ylim = yrange,  xlab = "Iteración",ylab = "Log-verosimilitud", main = "Modelo 5")
```
